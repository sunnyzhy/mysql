# 数据恢复

## 一、数据恢复的前提

### 1. 开启 binlog 日志

开启 binlog 日志，记录所有数据变更。

binlog（二进制日志）是 MySQL 记录所有 DDL（数据定义语言）和 DML（数据操纵语言）的日志，是恢复备份后新增数据的关键。

- 检查 binlog 是否开启

   ```bash
   mysql> show variables like '%log_bin%';
   ```

   若 log_bin 的值为 ```ON```，说明已开启；若为 ```OFF```，需手动配置开启。

- 开启 binlog

   1. 编辑 MySQL 配置文件：
      ```bash
      # vim /etc/my.cnf
	  server_id=2  # 唯一标识，需与其他实例不同
	  log_bin=mysql-bin  # binlog日志前缀
	  binlog_format=ROW  # 推荐ROW格式，记录数据行变更，恢复更精准
	  expire_logs_days=30  # 日志保留30天，避免占满磁盘
	  log_bin_basename=/var/lib/mysql/binlog/mysql-bin  # 日志存储路径
	  log_bin_index=/var/lib/mysql/binlog/mysql-bin.index  # 日志索引文件路径
      ```
   2. 重启 MySQL 服务：
       ```bash
       # systemctl restart mysqld
	   ```
 
   3. 再次执行 ```show variables like '%log_bin%'```，确认 log_bin 已变为 ```ON```。

### 2. 定期备份

备份是数据恢复的第一道防线，务必定期对数据库进行备份。

1. 编辑备份脚本

   ```bash
   # vim /usr/local/mysql/backup.sh
   
   # chmod +x /usr/local/mysql/backup.sh
   ```

   输入以下内容：

   ```sh
   #!/bin/bash
   #set -x
   date=`date +%Y%m%d`
   path=/usr/local/mysql/backup
   dbhost=127.0.0.1
   dbuser=root
   dbpasswd=root
   db=( $(mysql -h$dbhost -u$dbuser -p"$dbpasswd" -N -e "SHOW DATABASES LIKE 'st_%';") )
   if [ ! -d $path ] ;then
    mkdir ${path} && echo "creat backup dir success."
   fi
   cd $path
   mkdir -p $date
   cd $date
   for one in ${db[@]}
   do
       mysqldump  -h$dbhost -u$dbuser -p$dbpasswd $one > ${one}_${date}.sql
       tar -zcvf ${one}_${date}.tar.gz ${one}_${date}.sql
       rm -rf ${one}_${date}.sql
   done
   find $path -type d -mtime +10 -exec rm -rf {} \;
   ```

2. 加入定时任务

   ```bash
   # crontab -e
   59 23 * * * /usr/local/mysql/backup.sh
   ```

## 二、误删后的数据恢复

### 1. 定位 binlog 日志

binlog 是恢复备份后新增数据的核心，需先确认当前使用的 binlog 文件并妥善保存。

查看当前 binlog 状态：

```bash
mysql> show master status\G;
```

结果中File字段（如mysql-bin.000021）即为当前写入的 binlog 文件，Position为当前日志位置。

将当前 binlog 文件复制到非数据库目录（如 ```/root```），防止后续操作覆盖：

```bash
# cp /var/lib/mysql/binlog/mysql-bin.000021 /root
```

### 2. 解析 binlog 日志为可执行 SQL

binlog 是二进制文件，需用mysqlbinlog工具转换为可读的 SQL 语句，筛选出备份后到误删前的有效操作。

转换 binlog 为 SQL：

```bash
# mysqlbinlog -d test /root/mysql-bin.000021 > /root/binlog.sql
```

编辑 binlog.sql，删除误操作的语句（如 delete、drop），保留 insert、update 等有效操作：

```bash
# vim /root/binlog.sql
```

### 3. 恢复数据

恢复需分两步：先通过备份文件恢复到最近一次备份的状态，再通过处理后的 binlog SQL 补充备份后新增的数据。

恢复备份文件：

```bash
# mysql -h127.0.0.1 -uroot -proot < /usr/local/mysql/backup/test_20260105.sql
```

补充 binlog 中的新增数据：

```bash
# mysql -h127.0.0.1 -uroot -proot test < /root/binlog.sql
```

### 4. 验证恢复结果

登录 MySQL 查询目标表（如 test 库的 t 表）：

```bash
mysql> select * from test.t;
```

## 三、数据恢复的核心原则

- 开启 binlog（推荐 ROW 格式）+ 定期备份（至少每日一次），是数据安全的基础。
- 误删后尽快备份 binlog 日志，避免数据覆盖。
- 先恢复备份到历史状态，再用 binlog 补充增量数据。
